<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Star Wars Mystery - Multiplayer Clue</title>
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.0/dist/peerjs.min.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Georgia', serif;
    background: linear-gradient(135deg, #000000 0%, #0a1628 100%);
    color: #f0e6d2;
    min-height: 100vh;
    overflow-x: hidden;
}

/* Header */
.header {
    background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
    padding: 20px;
    text-align: center;
    border-bottom: 3px solid #FFE81F;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}

.header h1 {
    font-size: 2.5em;
    color: #FFE81F;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    font-style: italic;
    font-family: 'Arial Black', sans-serif;
}

.header p {
    font-size: 1.1em;
    margin-top: 10px;
    color: #4A9EFF;
}

/* Lobby */
.mode-selection {
    max-width: 900px;
    margin: 60px auto;
    padding: 40px;
    background: rgba(255,255,255,0.05);
    border-radius: 15px;
    border: 2px solid #FFE81F;
    backdrop-filter: blur(10px);
    text-align: center;
}

.mode-selection h2 {
    color: #FFE81F;
    font-size: 2.5em;
    margin-bottom: 40px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

.mode-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 30px;
    max-width: 700px;
    margin: 0 auto;
}

.mode-btn {
    background: linear-gradient(135deg, rgba(74, 158, 255, 0.2) 0%, rgba(74, 158, 255, 0.05) 100%);
    border: 3px solid #4A9EFF;
    border-radius: 15px;
    padding: 40px 30px;
    cursor: pointer;
    transition: all 0.3s;
    color: #f0e6d2;
    text-align: center;
}

.mode-btn:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(74, 158, 255, 0.4);
    border-color: #FFE81F;
    background: linear-gradient(135deg, rgba(74, 158, 255, 0.3) 0%, rgba(74, 158, 255, 0.1) 100%);
}

.mode-icon {
    font-size: 4em;
    margin-bottom: 15px;
}

.mode-btn h3 {
    color: #FFE81F;
    font-size: 1.8em;
    margin-bottom: 10px;
}

.mode-btn p {
    color: #4A9EFF;
    font-size: 1.1em;
    margin: 0;
}

@media (max-width: 768px) {
    .mode-buttons {
        grid-template-columns: 1fr;
        gap: 20px;
    }
}

.lobby {
    max-width: 800px;
    margin: 40px auto;
    padding: 30px;
    background: rgba(255,255,255,0.05);
    border-radius: 15px;
    border: 2px solid #FFE81F;
    backdrop-filter: blur(10px);
}

.lobby h2 {
    color: #FFE81F;
    margin-bottom: 20px;
    text-align: center;
}

.lobby-controls {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
}

.input-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.input-group label {
    font-weight: bold;
    color: #FFE81F;
}

.input-group input {
    padding: 10px;
    border: 2px solid #4A9EFF;
    border-radius: 8px;
    background: rgba(255,255,255,0.1);
    color: #f0e6d2;
    font-size: 16px;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    text-transform: uppercase;
}

.btn:disabled {
    cursor: not-allowed;
    opacity: 0.5;
}

.btn-primary {
    background: linear-gradient(135deg, #4A9EFF 0%, #1E5BA8 100%);
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #6BB0FF 0%, #2E6BC0 100%);
    transform: translateY(-2px);
}

.btn-secondary {
    background: linear-gradient(135deg, #FFE81F 0%, #D4AF37 100%);
    color: #000;
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #FFF44F 0%, #E6C547 100%);
}

.players-list {
    margin-top: 20px;
    padding: 15px;
    background: rgba(0,0,0,0.3);
    border-radius: 8px;
}

.players-list h3 {
    color: #FFE81F;
    margin-bottom: 10px;
}

.player-item {
    padding: 8px;
    margin: 5px 0;
    background: rgba(255,255,255,0.1);
    border-radius: 5px;
    border-left: 3px solid #4A9EFF;
}

/* Game Board */
.game-container {
    display: none;
    max-width: 1400px;
    margin: 20px auto;
    padding: 20px;
}

/* Turn Indicator */
.turn-indicator {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    border: 4px solid #fff;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    text-align: center;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
}

.turn-indicator h2 {
    color: #fff;
    font-size: 2.5em;
    margin: 0;
    text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
    font-weight: bold;
}

.turn-indicator h2::before {
    content: 'üë§ ';
}

.turn-indicator p {
    color: #fff;
    font-size: 1.4em;
    margin: 15px 0 0 0;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
}

.turn-indicator.my-turn {
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    border-color: #FFE81F;
    animation: pulse-green 1s ease-in-out infinite;
}

@keyframes pulse-green {
    0%, 100% {
        box-shadow: 0 6px 25px rgba(46, 204, 113, 0.8), 0 0 40px rgba(255, 215, 0, 0.5);
        transform: scale(1);
    }
    50% {
        box-shadow: 0 6px 35px rgba(46, 204, 113, 1), 0 0 60px rgba(255, 215, 0, 0.8);
        transform: scale(1.03);
    }
}

.turn-indicator.my-turn h2::before {
    content: '‚≠ê ';
}

.turn-indicator.my-turn p {
    color: #FFE81F;
}

.game-grid {
    display: grid;
    grid-template-columns: 300px 1fr 350px;
    gap: 20px;
}

/* Left Panel - Player Info */
.left-panel {
    background: rgba(255,255,255,0.05);
    border: 2px solid #FFE81F;
    border-radius: 10px;
    padding: 15px;
    max-height: 80vh;
    overflow-y: auto;
}

.player-card {
    background: rgba(74, 158, 255, 0.2);
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 8px;
    border-left: 4px solid #4A9EFF;
}

.player-card.active {
    border-left-color: #FFE81F;
    box-shadow: 0 0 15px rgba(255,215,0,0.3);
}

.player-card h4 {
    color: #FFE81F;
    margin-bottom: 5px;
}

.your-cards {
    margin-top: 20px;
}

.your-cards h3 {
    color: #FFE81F;
    margin-bottom: 10px;
}

.card-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.card-item {
    background: rgba(255,255,255,0.1);
    padding: 8px;
    border-radius: 5px;
    border-left: 3px solid;
}

.card-item.suspect {
    border-left-color: #e74c3c;
}

.card-item.weapon {
    border-left-color: #3498db;
}

.card-item.location {
    border-left-color: #2ecc71;
}

/* Center Panel - Game Board */
.center-panel {
    background: rgba(255,255,255,0.05);
    border: 2px solid #FFE81F;
    border-radius: 10px;
    padding: 20px;
}

.game-log {
    background: rgba(0,0,0,0.3);
    padding: 15px;
    border-radius: 8px;
    height: 250px;
    overflow-y: auto;
    margin-bottom: 20px;
    font-family: 'Courier New', monospace;
}

.log-entry {
    margin: 5px 0;
    padding: 5px;
    border-left: 3px solid #4A9EFF;
    padding-left: 10px;
}

.log-entry.important {
    border-left-color: #FFE81F;
    color: #FFE81F;
    font-weight: bold;
}

.suggestion-area {
    background: rgba(74, 158, 255, 0.15);
    padding: 20px;
    border-radius: 10px;
    border: 2px solid #4A9EFF;
}

.suggestion-area h3 {
    color: #FFE81F;
    margin-bottom: 15px;
}

.suggestion-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 15px;
}

.suggestion-column {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.suggestion-column label {
    font-weight: bold;
    color: #FFE81F;
    margin-bottom: 5px;
}

.suggestion-column select {
    padding: 8px;
    border: 2px solid #4A9EFF;
    border-radius: 5px;
    background: rgba(255,255,255,0.1);
    color: #f0e6d2;
    font-size: 14px;
}

.suggestion-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 15px;
}

/* Right Panel - Clue Sheet */
.right-panel {
    background: rgba(255,255,255,0.05);
    border: 2px solid #FFE81F;
    border-radius: 10px;
    padding: 15px;
    max-height: 80vh;
    overflow-y: auto;
}

.clue-sheet {
    background: rgba(0,0,0,0.3);
    padding: 15px;
    border-radius: 8px;
}

.clue-sheet h3 {
    color: #FFE81F;
    margin-bottom: 15px;
    text-align: center;
}

.clue-table-container {
    overflow-x: auto;
}

.clue-table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(255,255,255,0.05);
    border: 2px solid #4A9EFF;
    border-radius: 5px;
    overflow: hidden;
}

.clue-table th {
    background: rgba(74, 158, 255, 0.5);
    color: #FFE81F;
    padding: 10px 5px;
    text-align: center;
    font-weight: bold;
    border: 1px solid #4A9EFF;
    font-size: 11px;
}

.clue-table td {
    background: rgba(255,255,255,0.05);
    padding: 8px 5px;
    text-align: center;
    border: 1px solid #4A9EFF;
    font-size: 11px;
    transition: all 0.2s;
}

.clue-table td.item-name {
    text-align: left;
    padding-left: 10px;
    font-weight: bold;
    background: rgba(74, 158, 255, 0.2);
}

.clue-table td.suspect-item {
    color: #e74c3c;
}

.clue-table td.weapon-item {
    color: #3498db;
}

.clue-table td.location-item {
    color: #2ecc71;
}

.clue-table td.clickable {
    cursor: pointer;
}

.clue-table td.clickable:hover {
    background: rgba(255,255,255,0.15);
}

.clue-table td.has-card {
    background: rgba(46, 204, 113, 0.3);
    color: #2ecc71;
    font-size: 18px;
    font-weight: bold;
}

.clue-table td.marked-check {
    color: #2ecc71;
    font-size: 18px;
    font-weight: bold;
}

.clue-table td.marked-x {
    color: #e74c3c;
    font-size: 18px;
    font-weight: bold;
}

.clue-table td.marked-question {
    color: #f39c12;
    font-size: 18px;
    font-weight: bold;
}

.clue-section {
    margin-bottom: 20px;
}

.clue-section h4 {
    color: #FFE81F;
    margin-bottom: 10px;
    border-bottom: 2px solid #4A9EFF;
    padding-bottom: 5px;
}

/* Messages */
.message-box {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.95);
    border: 3px solid #FFE81F;
    border-radius: 15px;
    padding: 30px;
    z-index: 1000;
    display: none;
    text-align: center;
    max-width: 500px;
}

.message-box.show {
    display: block;
}

.message-box h2 {
    color: #FFE81F;
    margin-bottom: 15px;
}

.message-box p {
    font-size: 18px;
    margin-bottom: 20px;
}

.accusation-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 20px;
}

/* Responsive */
@media (max-width: 1200px) {
    .game-grid {
        grid-template-columns: 1fr;
    }
    
    .right-panel {
        max-height: none;
    }
}

.hidden {
    display: none !important;
}
</style>
</head>
<body>
    <div class="header">
        <h1>‚≠ê Star Wars Mystery ‚≠ê</h1>
        <p>A disturbance in the Force... someone has been eliminated!</p>
    </div>

    <!-- Game Mode Selection -->
    <div class="mode-selection" id="modeSelection">
        <h2>Choose Game Mode</h2>
        <div class="mode-buttons">
            <button class="mode-btn" onclick="startSinglePlayer()">
                <div class="mode-icon">ü§ñ</div>
                <h3>Single Player</h3>
                <p>Play against AI opponents</p>
            </button>
            <button class="mode-btn" onclick="showMultiplayer()">
                <div class="mode-icon">üë•</div>
                <h3>Multiplayer</h3>
                <p>Play with friends online</p>
            </button>
        </div>
    </div>

    <!-- Lobby Screen -->
    <div class="lobby hidden" id="lobby">
        <h2>Join or Create a Game</h2>
        
        <div class="lobby-controls">
            <div class="input-group">
                <label>Your Name:</label>
                <input type="text" id="playerName" placeholder="Enter your name">
            </div>
            
            <div class="input-group">
                <label>Room Code:</label>
                <input type="text" id="roomCode" placeholder="Enter room code or leave blank to create">
            </div>
            
            <button class="btn btn-primary" onclick="joinGame()">Join Game</button>
            <button class="btn btn-secondary" onclick="createGame()">Create New Game</button>
        </div>
        
        <div id="waitingArea" class="hidden">
            <div class="players-list">
                <h3>Players in Room:</h3>
                <div id="playersList"></div>
            </div>
            <p style="text-align: center; margin-top: 15px;">Room Code: <strong id="displayRoomCode"></strong></p>
            <button class="btn btn-primary" onclick="startGame()" id="startButton" style="margin-top: 15px; width: 100%;">Start Game</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div class="game-container" id="gameContainer">
        <!-- Turn Indicator Banner -->
        <div class="turn-indicator" id="turnIndicator">
            <h2 id="turnPlayerName">Waiting...</h2>
            <p id="turnStatus">The game will begin shortly</p>
        </div>
        
        <div class="game-grid">
            <!-- Left Panel -->
            <div class="left-panel">
                <h3 style="color: #FFE81F; margin-bottom: 15px;">Players</h3>
                <div id="playersStatus"></div>
                
                <div class="your-cards">
                    <h3>Your Cards</h3>
                    <div class="card-list" id="yourCards"></div>
                </div>
            </div>

            <!-- Center Panel -->
            <div class="center-panel">
                <div class="game-log" id="gameLog"></div>
                
                <div class="suggestion-area">
                    <h3>Make a Suggestion or Accusation</h3>
                    <div class="suggestion-grid">
                        <div class="suggestion-column">
                            <label>Suspect:</label>
                            <select id="suspectSelect"></select>
                        </div>
                        <div class="suggestion-column">
                            <label>Weapon:</label>
                            <select id="weaponSelect"></select>
                        </div>
                        <div class="suggestion-column">
                            <label>Location:</label>
                            <select id="locationSelect"></select>
                        </div>
                    </div>
                    <div class="suggestion-buttons">
                        <button class="btn btn-secondary" onclick="makeSuggestion()" id="suggestionBtn">Make Suggestion</button>
                        <button class="btn btn-primary" onclick="makeAccusation()" id="accusationBtn">Make Accusation</button>
                        <button class="btn" onclick="endTurn()" id="endTurnBtn" style="background: #f39c12; color: white;">End Turn ‚Üí</button>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <div class="clue-sheet">
                    <h3>üìù Detective Notes</h3>
                    <div class="clue-table-container">
                        <table class="clue-table" id="clueTable">
                            <!-- Will be populated by JavaScript -->
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div class="message-box" id="messageBox">
        <h2 id="messageTitle">Message</h2>
        <p id="messageText"></p>
        <button class="btn btn-primary" onclick="closeMessage()">Close</button>
    </div>

<script>
// Game Data
const SUSPECTS = [
    'Luke Skywalker',
    'Han Solo',
    'Princess Leia',
    'Darth Vader',
    'The Emperor',
    'Obi-Wan Kenobi'
];

const WEAPONS = [
    'Lightsaber',
    'Blaster',
    'Crossbow Blaster',
    'Grenades',
    'Death Star',
    'Force Choke'
];

const LOCATIONS = [
    'Tatooine',
    'Cantina Bar',
    'Coruscant',
    'Hoth',
    'Naboo',
    'Cloud City',
    'Jedi Temple',
    'Dagobah',
    'Alderaan'
];

// Game State
let peer = null;
let connections = [];
let isHost = false;
let roomCode = '';
let myPlayerId = '';
let myPlayerName = '';
let players = [];
let isSinglePlayer = false;
let gameState = {
    started: false,
    currentPlayerIndex: 0,
    solution: null,
    playerCards: {},
    clueSheet: {},
    turnHistory: []
};

// Initialize
function init() {
    populateSelects();
}

function startSinglePlayer() {
    isSinglePlayer = true;
    myPlayerName = 'You';
    myPlayerId = 'player-human';
    
    // Create AI players
    players = [
        {id: 'player-human', name: 'You', isHost: true},
        {id: 'player-ai1', name: 'R2-D2 (AI)', isHost: false},
        {id: 'player-ai2', name: 'C-3PO (AI)', isHost: false},
        {id: 'player-ai3', name: 'BB-8 (AI)', isHost: false}
    ];
    
    // Hide mode selection and start game
    document.getElementById('modeSelection').style.display = 'none';
    
    // Start game immediately
    startGameSinglePlayer();
}

function showMultiplayer() {
    isSinglePlayer = false;
    document.getElementById('modeSelection').style.display = 'none';
    document.getElementById('lobby').classList.remove('hidden');
}

function startGameSinglePlayer() {
    isHost = true;
    
    // Generate solution
    gameState.solution = {
        suspect: SUSPECTS[Math.floor(Math.random() * SUSPECTS.length)],
        weapon: WEAPONS[Math.floor(Math.random() * WEAPONS.length)],
        location: LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)]
    };
    
    // Create deck (all cards except solution)
    let deck = [];
    SUSPECTS.forEach(s => {
        if(s !== gameState.solution.suspect) deck.push({type: 'suspect', value: s});
    });
    WEAPONS.forEach(w => {
        if(w !== gameState.solution.weapon) deck.push({type: 'weapon', value: w});
    });
    LOCATIONS.forEach(l => {
        if(l !== gameState.solution.location) deck.push({type: 'location', value: l});
    });
    
    // Shuffle deck
    deck = shuffle(deck);
    
    // Deal cards
    let cardIndex = 0;
    players.forEach(p => {
        gameState.playerCards[p.id] = [];
    });
    
    while(cardIndex < deck.length) {
        players.forEach(p => {
            if(cardIndex < deck.length) {
                gameState.playerCards[p.id].push(deck[cardIndex]);
                cardIndex++;
            }
        });
    }
    
    // Initialize clue sheets
    players.forEach(p => {
        gameState.clueSheet[p.id] = {};
    });
    
    gameState.started = true;
    gameState.currentPlayerIndex = 0;
    
    startGameUI();
}

function populateSelects() {
    const suspectSelect = document.getElementById('suspectSelect');
    const weaponSelect = document.getElementById('weaponSelect');
    const locationSelect = document.getElementById('locationSelect');
    
    SUSPECTS.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        suspectSelect.appendChild(opt);
    });
    
    WEAPONS.forEach(w => {
        const opt = document.createElement('option');
        opt.value = w;
        opt.textContent = w;
        weaponSelect.appendChild(opt);
    });
    
    LOCATIONS.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l;
        opt.textContent = l;
        locationSelect.appendChild(opt);
    });
}

// Multiplayer Functions
function createGame() {
    const name = document.getElementById('playerName').value.trim();
    if(!name) {
        alert('Please enter your name!');
        return;
    }
    
    myPlayerName = name;
    isHost = true;
    roomCode = generateRoomCode();
    
    peer = new Peer(roomCode);
    
    peer.on('open', (id) => {
        myPlayerId = id;
        players.push({id: myPlayerId, name: myPlayerName, isHost: true});
        
        document.getElementById('displayRoomCode').textContent = roomCode;
        document.getElementById('waitingArea').classList.remove('hidden');
        updatePlayersList();
        
        addLog('Room created! Share code: ' + roomCode, true);
    });
    
    peer.on('connection', (conn) => {
        handleConnection(conn);
    });
}

function joinGame() {
    const name = document.getElementById('playerName').value.trim();
    const code = document.getElementById('roomCode').value.trim();
    
    if(!name || !code) {
        alert('Please enter your name and room code!');
        return;
    }
    
    myPlayerName = name;
    roomCode = code;
    
    peer = new Peer();
    
    peer.on('open', (id) => {
        myPlayerId = id;
        const conn = peer.connect(roomCode);
        handleConnection(conn);
        
        conn.on('open', () => {
            conn.send({
                type: 'join',
                playerId: myPlayerId,
                playerName: myPlayerName
            });
        });
    });
}

function handleConnection(conn) {
    connections.push(conn);
    
    conn.on('data', (data) => {
        handleMessage(data, conn);
    });
    
    conn.on('close', () => {
        connections = connections.filter(c => c !== conn);
    });
}

function handleMessage(data, conn) {
    switch(data.type) {
        case 'join':
            if(isHost) {
                players.push({id: data.playerId, name: data.playerName, isHost: false});
                broadcast({type: 'players', players: players});
                updatePlayersList();
            }
            break;
            
        case 'players':
            players = data.players;
            document.getElementById('displayRoomCode').textContent = roomCode;
            document.getElementById('waitingArea').classList.remove('hidden');
            updatePlayersList();
            break;
            
        case 'start':
            gameState = data.gameState;
            startGameUI();
            break;
            
        case 'suggestion':
            handleSuggestion(data);
            break;
            
        case 'accusation':
            handleAccusation(data);
            break;
            
        case 'showCard':
            handleShowCard(data);
            break;
            
        case 'noCard':
            handleNoCard(data);
            break;
            
        case 'nextTurn':
            gameState.currentPlayerIndex = data.nextPlayerIndex;
            updatePlayersStatus();
            addLog(`${data.playerName}'s turn`, true);
            break;
    }
}

function broadcast(data) {
    connections.forEach(conn => {
        if(conn.open) {
            conn.send(data);
        }
    });
}

function updatePlayersList() {
    const list = document.getElementById('playersList');
    list.innerHTML = '';
    
    players.forEach(p => {
        const div = document.createElement('div');
        div.className = 'player-item';
        div.textContent = p.name + (p.isHost ? ' (Host)' : '');
        list.appendChild(div);
    });
}

function generateRoomCode() {
    return 'SW-' + Math.random().toString(36).substr(2, 6).toUpperCase();
}

// Game Logic
function startGame() {
    if(!isHost) return;
    if(players.length < 2) {
        alert('Need at least 2 players to start!');
        return;
    }
    
    // Generate solution
    gameState.solution = {
        suspect: SUSPECTS[Math.floor(Math.random() * SUSPECTS.length)],
        weapon: WEAPONS[Math.floor(Math.random() * WEAPONS.length)],
        location: LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)]
    };
    
    // Create deck (all cards except solution)
    let deck = [];
    SUSPECTS.forEach(s => {
        if(s !== gameState.solution.suspect) deck.push({type: 'suspect', value: s});
    });
    WEAPONS.forEach(w => {
        if(w !== gameState.solution.weapon) deck.push({type: 'weapon', value: w});
    });
    LOCATIONS.forEach(l => {
        if(l !== gameState.solution.location) deck.push({type: 'location', value: l});
    });
    
    // Shuffle deck
    deck = shuffle(deck);
    
    // Deal cards
    let cardIndex = 0;
    players.forEach(p => {
        gameState.playerCards[p.id] = [];
    });
    
    while(cardIndex < deck.length) {
        players.forEach(p => {
            if(cardIndex < deck.length) {
                gameState.playerCards[p.id].push(deck[cardIndex]);
                cardIndex++;
            }
        });
    }
    
    // Initialize clue sheets
    players.forEach(p => {
        gameState.clueSheet[p.id] = {};
    });
    
    gameState.started = true;
    gameState.currentPlayerIndex = 0;
    
    // Send game state to all players
    broadcast({type: 'start', gameState: gameState});
    
    startGameUI();
}

function startGameUI() {
    document.getElementById('lobby').style.display = 'none';
    document.getElementById('gameContainer').style.display = 'block';
    
    // Display your cards
    const yourCardsDiv = document.getElementById('yourCards');
    yourCardsDiv.innerHTML = '';
    
    const myCards = gameState.playerCards[myPlayerId] || [];
    myCards.forEach(card => {
        const div = document.createElement('div');
        div.className = `card-item ${card.type}`;
        div.textContent = card.value;
        yourCardsDiv.appendChild(div);
    });
    
    // Initialize clue sheet
    initClueSheet();
    updatePlayersStatus();
    addLog('Game started! The mystery begins...', true);
    
    const currentPlayer = players[gameState.currentPlayerIndex];
    addLog(`${currentPlayer.name}'s turn`, true);
}

function initClueSheet() {
    const table = document.getElementById('clueTable');
    table.innerHTML = '';
    
    // Get ONLY my cards
    const myCards = gameState.playerCards[myPlayerId] || [];
    const myCardValues = myCards.map(c => c.value);
    
    console.log('My Player ID:', myPlayerId);
    console.log('My Cards:', myCardValues);
    console.log('All Player Cards:', gameState.playerCards);
    
    // Create header row
    const headerRow = document.createElement('tr');
    const itemHeader = document.createElement('th');
    itemHeader.textContent = 'Card';
    itemHeader.style.width = '140px';
    headerRow.appendChild(itemHeader);
    
    // Add player columns
    players.forEach(p => {
        const th = document.createElement('th');
        th.textContent = p.name.split(' ')[0];
        th.style.width = '60px';
        headerRow.appendChild(th);
    });
    
    table.appendChild(headerRow);
    
    // Add all items
    const allItems = [
        ...SUSPECTS.map(s => ({type: 'suspect', value: s})),
        ...WEAPONS.map(w => ({type: 'weapon', value: w})),
        ...LOCATIONS.map(l => ({type: 'location', value: l}))
    ];
    
    allItems.forEach(item => {
        const row = document.createElement('tr');
        
        // Item name cell
        const nameCell = document.createElement('td');
        nameCell.className = `item-name ${item.type}-item`;
        nameCell.textContent = item.value;
        row.appendChild(nameCell);
        
        // Player columns
        players.forEach((p, idx) => {
            const cell = document.createElement('td');
            
            // If this is MY column - all cells are clickable for my notes
            if(p.id === myPlayerId) {
                cell.className = 'clickable';
                cell.dataset.item = item.value;
                cell.dataset.playerIndex = idx;
                cell.onclick = () => cycleClueCell(cell);
            } 
            // If this is ANOTHER player's column AND I have this card
            // Show green check (they CAN'T have it since I do)
            else if(myCardValues.includes(item.value)) {
                cell.className = 'has-card';
                cell.textContent = '‚úì';
                cell.title = "You have this card, so they don't";
            }
            // If this is ANOTHER player's column AND I DON'T have this card
            // Make it clickable for notes
            else {
                cell.className = 'clickable';
                cell.dataset.item = item.value;
                cell.dataset.playerIndex = idx;
                cell.onclick = () => cycleClueCell(cell);
            }
            
            row.appendChild(cell);
        });
        
        table.appendChild(row);
    });
}

function cycleClueCell(cell) {
    if(cell.classList.contains('marked-check')) {
        cell.classList.remove('marked-check');
        cell.classList.add('marked-x');
        cell.textContent = '‚úó';
    } else if(cell.classList.contains('marked-x')) {
        cell.classList.remove('marked-x');
        cell.classList.add('marked-question');
        cell.textContent = '?';
    } else if(cell.classList.contains('marked-question')) {
        cell.classList.remove('marked-question');
        cell.textContent = '';
    } else {
        cell.classList.add('marked-check');
        cell.textContent = '‚úì';
    }
}

function updatePlayersStatus() {
    const div = document.getElementById('playersStatus');
    div.innerHTML = '';
    
    const currentPlayer = players[gameState.currentPlayerIndex];
    const isMyTurn = currentPlayer && currentPlayer.id === myPlayerId;
    
    // Update turn indicator banner
    const turnIndicator = document.getElementById('turnIndicator');
    const turnPlayerName = document.getElementById('turnPlayerName');
    const turnStatus = document.getElementById('turnStatus');
    
    if(currentPlayer) {
        if(isMyTurn) {
            turnPlayerName.textContent = "YOUR TURN";
            turnStatus.textContent = "Make a suggestion or accusation, then end your turn";
            turnIndicator.classList.add('my-turn');
        } else {
            turnPlayerName.textContent = currentPlayer.name + "'s Turn";
            turnStatus.textContent = "Waiting for " + currentPlayer.name + " to play...";
            turnIndicator.classList.remove('my-turn');
        }
    }
    
    // Enable/disable buttons based on turn
    const suggestionBtn = document.getElementById('suggestionBtn');
    const accusationBtn = document.getElementById('accusationBtn');
    const endTurnBtn = document.getElementById('endTurnBtn');
    
    if(suggestionBtn && accusationBtn && endTurnBtn) {
        if(isMyTurn) {
            suggestionBtn.disabled = false;
            accusationBtn.disabled = false;
            endTurnBtn.disabled = false;
            suggestionBtn.style.opacity = '1';
            accusationBtn.style.opacity = '1';
            endTurnBtn.style.opacity = '1';
        } else {
            suggestionBtn.disabled = true;
            accusationBtn.disabled = true;
            endTurnBtn.disabled = true;
            suggestionBtn.style.opacity = '0.5';
            accusationBtn.style.opacity = '0.5';
            endTurnBtn.style.opacity = '0.5';
        }
    }
    
    players.forEach((p, idx) => {
        const card = document.createElement('div');
        card.className = 'player-card';
        if(idx === gameState.currentPlayerIndex) {
            card.classList.add('active');
        }
        
        const name = document.createElement('h4');
        name.textContent = p.name + (p.id === myPlayerId ? ' (You)' : '');
        card.appendChild(name);
        
        const cardCount = document.createElement('p');
        cardCount.textContent = `Cards: ${(gameState.playerCards[p.id] || []).length}`;
        card.appendChild(cardCount);
        
        div.appendChild(card);
    });
}

function makeSuggestion() {
    const currentPlayer = players[gameState.currentPlayerIndex];
    if(currentPlayer.id !== myPlayerId) {
        alert('It\'s not your turn!');
        return;
    }
    
    const suspect = document.getElementById('suspectSelect').value;
    const weapon = document.getElementById('weaponSelect').value;
    const location = document.getElementById('locationSelect').value;
    
    const suggestion = {suspect, weapon, location};
    
    // Initialize tracking for no-card responses
    gameState.noCardResponses = [];
    
    addLog(`${myPlayerName} suggests: ${suspect}, ${weapon}, ${location}`, true);
    
    if(!isSinglePlayer) {
        broadcast({
            type: 'suggestion',
            playerId: myPlayerId,
            playerName: myPlayerName,
            suggestion: suggestion
        });
    }
    
    // In single player, check AI players for matching cards
    if(isSinglePlayer) {
        handleSinglePlayerSuggestion(suggestion);
    } else {
        handleSuggestion({
            playerId: myPlayerId,
            playerName: myPlayerName,
            suggestion: suggestion
        });
    }
}

function handleSinglePlayerSuggestion(suggestion) {
    // Check each AI player for matching cards
    let cardShown = false;
    
    for(let i = 1; i < players.length; i++) {
        const nextPlayerIdx = (gameState.currentPlayerIndex + i) % players.length;
        const aiPlayer = players[nextPlayerIdx];
        
        if(aiPlayer.id === myPlayerId) continue;
        
        const aiCards = gameState.playerCards[aiPlayer.id] || [];
        const matchingCards = aiCards.filter(card => 
            card.value === suggestion.suspect || 
            card.value === suggestion.weapon || 
            card.value === suggestion.location
        );
        
        if(matchingCards.length > 0) {
            // AI shows a random matching card
            const cardToShow = matchingCards[Math.floor(Math.random() * matchingCards.length)];
            addLog(`${aiPlayer.name} showed you: ${cardToShow.value}`, true);
            cardShown = true;
            break;
        } else {
            addLog(`${aiPlayer.name} has none of the suggested cards`);
        }
    }
    
    if(!cardShown) {
        showMessage('No Matches!', 'No one has any of the cards you suggested. This is valuable information!');
    }
}

function handleSuggestion(data) {
    const {playerId, playerName, suggestion} = data;
    
    addLog(`${playerName} suggests: ${suggestion.suspect}, ${suggestion.weapon}, ${suggestion.location}`);
    
    // Show popup to all players (except the suggester)
    if(playerId !== myPlayerId) {
        const myCards = gameState.playerCards[myPlayerId] || [];
        const matchingCards = myCards.filter(card => 
            card.value === suggestion.suspect || 
            card.value === suggestion.weapon || 
            card.value === suggestion.location
        );
        
        // Show dialog regardless of whether they have cards
        showCardChoice(matchingCards, playerId, playerName, suggestion);
    }
}

function endTurn() {
    const currentPlayer = players[gameState.currentPlayerIndex];
    if(!currentPlayer || currentPlayer.id !== myPlayerId) {
        alert("It's not your turn!");
        return;
    }
    
    const nextPlayerIndex = (gameState.currentPlayerIndex + 1) % players.length;
    const nextPlayer = players[nextPlayerIndex];
    
    gameState.currentPlayerIndex = nextPlayerIndex;
    
    if(!isSinglePlayer) {
        broadcast({
            type: 'nextTurn',
            nextPlayerIndex: nextPlayerIndex,
            playerName: nextPlayer.name
        });
    }
    
    updatePlayersStatus();
    addLog(`${myPlayerName} ended their turn`, true);
    addLog(`${nextPlayer.name}'s turn`, true);
    
    // In single player, run AI turns
    if(isSinglePlayer && nextPlayer.id !== myPlayerId) {
        setTimeout(() => runAITurn(nextPlayer), 1500);
    }
}

function runAITurn(aiPlayer) {
    if(gameState.currentPlayerIndex !== players.indexOf(aiPlayer)) return;
    
    addLog(`${aiPlayer.name}'s turn`, true);
    
    // AI makes a random suggestion
    const suspect = SUSPECTS[Math.floor(Math.random() * SUSPECTS.length)];
    const weapon = WEAPONS[Math.floor(Math.random() * WEAPONS.length)];
    const location = LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)];
    
    addLog(`${aiPlayer.name} suggests: ${suspect}, ${weapon}, ${location}`, true);
    
    // Check human player for matching cards
    setTimeout(() => {
        const myCards = gameState.playerCards[myPlayerId] || [];
        const matchingCards = myCards.filter(card => 
            card.value === suspect || 
            card.value === weapon || 
            card.value === location
        );
        
        if(matchingCards.length > 0) {
            // Show popup for human to choose which card to show
            showAISuggestionDialog(matchingCards, aiPlayer, {suspect, weapon, location});
        } else {
            addLog(`You have none of ${aiPlayer.name}'s suggested cards`);
            
            // AI turn ends, move to next player
            setTimeout(() => {
                gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % players.length;
                updatePlayersStatus();
                
                const nextPlayer = players[gameState.currentPlayerIndex];
                addLog(`${nextPlayer.name}'s turn`, true);
                
                if(nextPlayer.id !== myPlayerId) {
                    setTimeout(() => runAITurn(nextPlayer), 1500);
                }
            }, 1000);
        }
    }, 1000);
}

function showAISuggestionDialog(matchingCards, aiPlayer, suggestion) {
    let msg = `<strong>${aiPlayer.name}</strong> suggests:<br>`;
    msg += `<div style="background: rgba(74, 158, 255, 0.2); padding: 10px; margin: 10px 0; border-radius: 5px;">`;
    msg += `üîç <strong>${suggestion.suspect}</strong><br>`;
    msg += `üó°Ô∏è <strong>${suggestion.weapon}</strong><br>`;
    msg += `üèõÔ∏è <strong>${suggestion.location}</strong>`;
    msg += `</div>`;
    msg += `<p style="color: #2ecc71; font-weight: bold;">You have matching cards! Choose one to show:</p>`;
    
    let cardButtons = '';
    matchingCards.forEach(card => {
        cardButtons += `<button class="btn btn-secondary" style="margin: 5px;" onclick="showCardToAI('${card.value}', '${aiPlayer.id}', '${aiPlayer.name}')">${card.value}</button><br>`;
    });
    
    document.getElementById('messageTitle').textContent = 'Suggestion from ' + aiPlayer.name;
    document.getElementById('messageText').innerHTML = msg + cardButtons;
    document.getElementById('messageBox').classList.add('show');
}

function showCardToAI(cardValue, aiPlayerId, aiPlayerName) {
    closeMessage();
    addLog(`You showed ${cardValue} to ${aiPlayerName}`);
    
    // AI turn ends, move to next player
    setTimeout(() => {
        gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % players.length;
        updatePlayersStatus();
        
        const nextPlayer = players[gameState.currentPlayerIndex];
        addLog(`${nextPlayer.name}'s turn`, true);
        
        if(nextPlayer.id !== myPlayerId) {
            setTimeout(() => runAITurn(nextPlayer), 1500);
        }
    }, 500);
}

function showCardChoice(cards, requesterId, requesterName, suggestion) {
    let msg = `<strong>${requesterName}</strong> suggests:<br>`;
    msg += `<div style="background: rgba(74, 158, 255, 0.2); padding: 10px; margin: 10px 0; border-radius: 5px;">`;
    msg += `üîç <strong>${suggestion.suspect}</strong><br>`;
    msg += `üó°Ô∏è <strong>${suggestion.weapon}</strong><br>`;
    msg += `üèõÔ∏è <strong>${suggestion.location}</strong>`;
    msg += `</div>`;
    
    if(cards.length > 0) {
        msg += `<p style="color: #2ecc71; font-weight: bold;">You have matching cards! Choose one to show:</p>`;
    } else {
        msg += `<p style="color: #e74c3c;">You don't have any of these cards.</p>`;
    }
    
    let cardButtons = '';
    
    cards.forEach(card => {
        cardButtons += `<button class="btn btn-secondary" style="margin: 5px;" onclick="showCardToPlayer('${card.value}', '${requesterId}', '${requesterName}')">${card.value}</button><br>`;
    });
    
    cardButtons += `<button class="btn" style="margin: 5px; background: #95a5a6; color: white;" onclick="showNone('${requesterId}', '${requesterName}')">I Have None of These</button>`;
    
    document.getElementById('messageTitle').textContent = 'Suggestion from ' + requesterName;
    document.getElementById('messageText').innerHTML = msg + cardButtons;
    document.getElementById('messageBox').classList.add('show');
}

function showNone(requesterId, requesterName) {
    closeMessage();
    
    const conn = connections.find(c => c.peer === requesterId);
    if(conn) {
        conn.send({
            type: 'noCard',
            fromPlayer: myPlayerName
        });
    }
    
    addLog(`You have none of ${requesterName}'s suggested cards`);
}

function showCardToPlayer(cardValue, requesterId, requesterName) {
    closeMessage();
    
    const conn = connections.find(c => c.peer === requesterId);
    if(conn) {
        conn.send({
            type: 'showCard',
            cardValue: cardValue,
            fromPlayer: myPlayerName
        });
    }
    
    addLog(`You showed ${cardValue} to ${requesterName}`);
}

function handleShowCard(data) {
    addLog(`${data.fromPlayer} showed you: ${data.cardValue}`, true);
}

function handleNoCard(data) {
    addLog(`${data.fromPlayer} has none of the suggested cards`);
    
    // Check if all players have responded with no card
    if(!gameState.noCardResponses) {
        gameState.noCardResponses = [];
    }
    
    gameState.noCardResponses.push(data.fromPlayer);
    
    // If all other players have said no
    const otherPlayers = players.filter(p => p.id !== myPlayerId);
    if(gameState.noCardResponses.length >= otherPlayers.length) {
        showMessage('No Matches!', 'No one has any of the cards you suggested. This is valuable information!');
        gameState.noCardResponses = [];
    }
}

function makeAccusation() {
    const currentPlayer = players[gameState.currentPlayerIndex];
    if(currentPlayer.id !== myPlayerId) {
        alert('It\'s not your turn!');
        return;
    }
    
    const suspect = document.getElementById('suspectSelect').value;
    const weapon = document.getElementById('weaponSelect').value;
    const location = document.getElementById('locationSelect').value;
    
    const accusation = {suspect, weapon, location};
    
    if(!isSinglePlayer) {
        broadcast({
            type: 'accusation',
            playerId: myPlayerId,
            playerName: myPlayerName,
            accusation: accusation
        });
    }
    
    handleAccusation({
        playerId: myPlayerId,
        playerName: myPlayerName,
        accusation: accusation
    });
}

function handleAccusation(data) {
    const {playerName, accusation} = data;
    
    addLog(`${playerName} accuses: ${accusation.suspect}, ${accusation.weapon}, ${accusation.location}`, true);
    
    const correct = 
        accusation.suspect === gameState.solution.suspect &&
        accusation.weapon === gameState.solution.weapon &&
        accusation.location === gameState.solution.location;
    
    if(correct) {
        showMessage('Game Over!', `${playerName} wins! The solution was: ${gameState.solution.suspect}, ${gameState.solution.weapon}, ${gameState.solution.location}`);
        addLog(`${playerName} WINS!`, true);
    } else {
        showMessage('Wrong Accusation!', `${playerName}'s accusation was incorrect. They are eliminated from making further accusations.`);
        addLog(`${playerName}'s accusation was wrong!`);
    }
}

// Utility Functions
function shuffle(array) {
    const arr = [...array];
    for(let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

function addLog(text, important = false) {
    const log = document.getElementById('gameLog');
    const entry = document.createElement('div');
    entry.className = 'log-entry' + (important ? ' important' : '');
    entry.textContent = text;
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
}

function showMessage(title, text) {
    document.getElementById('messageTitle').textContent = title;
    document.getElementById('messageText').textContent = text;
    document.getElementById('messageBox').classList.add('show');
}

function closeMessage() {
    document.getElementById('messageBox').classList.remove('show');
}

// Initialize on load
window.onload = init;
</script>
</body>
</html>